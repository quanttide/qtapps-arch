# 用户认证 

## 密码安全

最理想的方法是自己的服务器不存密码。

使用云开发的登录鉴权能力，但是主要使用它作为一个数据中台，不用它的登录鉴权能力。在这样的情况下，相当于把手机和邮箱登录托管给云开发，类似于OAuth2的方式管理登录。由于云开发的账号系统可以绑定很多微信体系的账号，这样内部的负担也轻很多。在开发者服务器，调用HTTP接口把数据传给云开发登录鉴权验证。在这个基础上依然可以很方便地打包自己的用户数据。

实际情况是，云开发登录鉴权没有提供HTTP接口文档（但理论上可以要或者看源码），鉴权和其他功能的耦合度也比较高，怀疑是否有可行性，需要问一下云开发团队。

## 多设备安全

多设备登录为必须特性，我们可能需要用户可以同时使用两三个设备无缝学习，甚至可能需要两三个设备同时使用以实现一边看视频一边写代码的效果。

由于设计的认证机制为JWT，以计算而非缓存形式处理，因此**比较难在不增加其他机制的前提下，让如下约束机制发挥作用**。换句话说，基于JWT机制的设备数量约束比较难实现。

但我们无法放弃JWT机制，也不应当缓存JWT来实现类似于Session的效果。一方面，这会影响多设备登录实现机制；另一方面，云原生应用应当是无状态的，JWT机制可以很好地保证服务端的无状态，以方便未来可能的不停机迁移（如果缓存了状态，缓存则无法清空时不影响用户使用）。

**需要大量收集用户数据迭代优化安全算法。**

## 安全机制需求

### 约束同类型设备最多一个
服务端可以约束同类型设备（mobile/tablet/desktop/web）只能存在一个

### 限制最大设备登录数量
遵循云点播Key防盗链最多3 or N 个设备的限制，防止付费用户登录多个用户设备使用。

### 通过IP验证是否为同一用户
服务端还可以通过检验设备IP来查看是否被多个人使用，通过验证码防止风险访问。

## 安全机制设计
通过一个独立中台管理用户设备。核心设计思路如下。

### 设备唯一性
- Android、iOS、Win、Mac等客户端通过设备ID来识别。
- Web通过（设备ID和）浏览器ID识别。
- 小米照明弹机制，如果对同一个APP发固定ID，则直接使用即可。
- 无标记的设备发临时ID/半永久ID，客户端只要不被删配置文件就可用，Web只要不被清缓存就可以用。

具体还要根据各个设备的ID机制和缓存持久化的机制决定，需要深入研究设计和反复测试，设计时需要为异常情况设计一个通用的处理机制。

### 设备匹配用户
这是一个many-to-many模型，一个设备可能登陆多个用户，一个用户可能登陆多个设备。
用此表可以采集我们想要的用户数据，用以**数据分析->迭代安全算法**。

### 基于设备唯一的JWT验证机制
核心机制是，通过存储的设备信息来进行验证，实现一个安全算法即可。由于安全算法被解耦，所以**可以迭代**。
安全算法可通过以下分块拆分，每个算法之间都是and的关系，即必须全部通过才可验证成功。
- 对于同类设备验证，增加一个**last_login**字段即可，只允许last_login最靠后的设备可通过验证；
- 同类设备约束已经可以隐含实现设备数量限制；
- IP约束同样也包含在上述约束里。

